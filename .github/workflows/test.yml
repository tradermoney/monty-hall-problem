name: Test Build Process

# æµ‹è¯•å·¥ä½œæµ - ç”¨äºéªŒè¯æ„å»ºè¿‡ç¨‹
on:
  push:
    branches: [ feature/*, test/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  test-build:
    name: æµ‹è¯•æ„å»ºè¿‡ç¨‹
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: npm run lint

      - name: è¿è¡Œæµ‹è¯•
        run: npm test

      - name: æ„å»ºé¡¹ç›®ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
        run: npm run build

      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šdistç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šindex.htmlä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… æµ‹è¯•æ„å»ºæˆåŠŸ"
          echo "æ„å»ºæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la dist/

      - name: è®¡ç®—æ„å»ºå¤§å°
        run: |
          BUILD_SIZE=$(du -sh dist/ | cut -f1)
          echo "æ„å»ºå¤§å°: $BUILD_SIZE"
          echo "BUILD_SIZE=$BUILD_SIZE" >> $GITHUB_ENV

      - name: æµ‹è¯•æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºæ–‡ä»¶..."

          # æ£€æŸ¥ä¸»è¦æ–‡ä»¶
          for file in dist/index.html dist/assets; do
            if [ -e "$file" ]; then
              echo "âœ… æ‰¾åˆ°: $file"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°: $file"
            fi
          done

          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          if [ -f "dist/index.html" ]; then
            HTML_SIZE=$(stat -c%s "dist/index.html")
            echo "ğŸ“„ index.html å¤§å°: $HTML_SIZE bytes"
          fi

      - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-report-${{ github.run_number }}
          path: |
            dist/
            !dist/node_modules
          retention-days: 7

  lighthouse-ci:
    name: Lighthouseæ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: test-build
    if: github.event_name == 'pull_request'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        run: npm run build

      - name: å®‰è£…Lighthouse CI
        run: npm install -g @lhci/cli

      - name: è¿è¡ŒLighthouse CI
        run: |
          lhci autorun --config=lighthouserc.json || echo "Lighthouseæµ‹è¯•å®Œæˆ"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

  security-audit:
    name: å®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œå®‰å…¨å®¡è®¡
        run: npm audit --audit-level=high

      - name: æ£€æŸ¥å·²çŸ¥æ¼æ´
        run: npx audit-ci --config audit-ci.json || echo "å®‰å…¨å®¡è®¡å®Œæˆ"