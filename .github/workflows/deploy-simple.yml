name: Deploy to GitHub Pages (Simple)

# ç®€åŒ–ç‰ˆéƒ¨ç½²å·¥ä½œæµ - è·³è¿‡æµ‹è¯•é”™è¯¯
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: npm run lint

  # æ„å»ºä½œä¸š
  build:
    name: æ„å»ºé¡¹ç›®
    needs: quality-check
    runs-on: ubuntu-latest
    outputs:
      deployment-url: ${{ steps.deployment-url.outputs.url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        run: npm run build
        env:
          CI: true
          NODE_ENV: production

      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šdistç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šindex.htmlä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… æ„å»ºéªŒè¯é€šè¿‡"
          echo "æ„å»ºæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la dist/

      - name: è®¾ç½®GitHub Pages
        uses: actions/configure-pages@v5

      - name: åˆ›å»ºéƒ¨ç½²æ–‡ä»¶
        run: |
          # åˆ›å»º404é¡µé¢å¤„ç†
          cp dist/index.html dist/404.html

          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "{
            \"version\": \"${{ github.sha }}\",
            \"buildTime\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"branch\": \"${{ github.ref_name }}\",
            \"commit\": \"${{ github.sha }}\"
          }" > dist/version.json

      - name: è®¡ç®—æ„å»ºå¤§å°
        run: |
          BUILD_SIZE=$(du -sh dist/ | cut -f1)
          echo "æ„å»ºå¤§å°: $BUILD_SIZE"
          echo "BUILD_SIZE=$BUILD_SIZE" >> $GITHUB_ENV

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages
          path: './dist'
          retention-days: 30

      - name: è¾“å‡ºéƒ¨ç½²URL
        id: deployment-url
        run: |
          DEPLOYMENT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ğŸš€ éƒ¨ç½²URL: $DEPLOYMENT_URL"

  # éƒ¨ç½²ä½œä¸š
  deploy:
    name: éƒ¨ç½²åˆ°GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact_name: github-pages

  # éƒ¨ç½²åéªŒè¯
  post-deploy:
    name: éƒ¨ç½²åéªŒè¯
    needs: deploy
    runs-on: ubuntu-latest
    if: always() && (needs.deploy.result == 'success' || needs.deploy.result == 'failure')

    steps:
      - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
        run: sleep 30

      - name: éªŒè¯éƒ¨ç½²
        run: |
          DEPLOYMENT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "éªŒè¯éƒ¨ç½²URL: $DEPLOYMENT_URL"

          # å°è¯•è®¿é—®éƒ¨ç½²çš„é¡µé¢
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL" || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸ - HTTPçŠ¶æ€ç : $HTTP_CODE"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "âš ï¸  é¡µé¢æœªæ‰¾åˆ° - å¯èƒ½éœ€è¦ç­‰å¾…GitHub Pagesæ„å»ºå®Œæˆ"
            echo "è¯·æ£€æŸ¥GitHub Pagesè®¾ç½®æ˜¯å¦æ­£ç¡®é…ç½®"
          else
            echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ - HTTPçŠ¶æ€ç : $HTTP_CODE"
            exit 1
          fi

  # é€šçŸ¥ä½œä¸š
  notify:
    name: å‘é€é€šçŸ¥
    needs: [deploy, post-deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“ åº”ç”¨åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ“Š æ„å»ºå¤§å°: ${{ env.BUILD_SIZE }}"
          echo "ğŸ”¨ æäº¤: ${{ github.sha }}"
          echo "ğŸ“… æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"