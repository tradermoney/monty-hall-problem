name: Build Only

# ä»…æž„å»ºå·¥ä½œæµ - è·³è¿‡æµ‹è¯•å’Œç±»åž‹æ£€æŸ¥
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: ä»…æž„å»ºé¡¹ç›®
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ç›´æŽ¥æž„å»ºé¡¹ç›®ï¼ˆè·³è¿‡ç±»åž‹æ£€æŸ¥ï¼‰
        run: npx vite build
        env:
          CI: true
          NODE_ENV: production

      - name: éªŒè¯æž„å»ºç»“æžœ
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ æž„å»ºå¤±è´¥ï¼šdistç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "âŒ æž„å»ºå¤±è´¥ï¼šindex.htmlä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… æž„å»ºéªŒè¯é€šè¿‡"
          echo "æž„å»ºæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la dist/

      - name: æ£€æŸ¥æž„å»ºæ–‡ä»¶
        run: |
          echo "ðŸ” æ£€æŸ¥æž„å»ºæ–‡ä»¶..."

          # æ£€æŸ¥ä¸»è¦æ–‡ä»¶
          for file in dist/index.html dist/assets; do
            if [ -e "$file" ]; then
              echo "âœ… æ‰¾åˆ°: $file"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°: $file"
            fi
          done

          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          if [ -f "dist/index.html" ]; then
            HTML_SIZE=$(stat -c%s "dist/index.html")
            echo "ðŸ“„ index.html å¤§å°: $HTML_SIZE bytes"
          fi

          # è®¡ç®—æ€»å¤§å°
          BUILD_SIZE=$(du -sh dist/ | cut -f1)
          echo "ðŸ“¦ æ€»æž„å»ºå¤§å°: $BUILD_SIZE"

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_number }}
          path: |
            dist/
            !dist/node_modules
          retention-days: 7

  # å¯é€‰ï¼šéƒ¨ç½²åˆ°ä¸´æ—¶çŽ¯å¢ƒè¿›è¡Œæµ‹è¯•
  deploy-preview:
    name: éƒ¨ç½²é¢„è§ˆç‰ˆæœ¬
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v5
        with:
          name: build-artifacts-${{ github.run_number }}
          path: ./dist

      - name: åˆ›å»ºé¢„è§ˆéƒ¨ç½²
        run: |
          echo "ðŸ“‹ PRé¢„è§ˆéƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "PRç¼–å·: #${{ github.event.pull_request.number }}"
          echo "åˆ†æ”¯: ${{ github.head_ref }}"
          echo "æž„å»ºäº§ç‰©å·²å‡†å¤‡å°±ç»ª"
          echo "å¯ä»¥åœ¨æœ¬åœ°ä½¿ç”¨ 'npm run preview' æµ‹è¯•æž„å»ºç»“æžœ"

      - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          cat > deployment-report.md << EOF
          # éƒ¨ç½²é¢„è§ˆæŠ¥å‘Š

          ## æž„å»ºä¿¡æ¯
          - **æäº¤**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.head_ref }}
          - **æž„å»ºæ—¶é—´**: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ## æž„å»ºç»“æžœ
          - âœ… æž„å»ºæˆåŠŸ
          - ðŸ“¦ æž„å»ºå¤§å°: $(du -sh dist/ | cut -f1)

          ## æµ‹è¯•å»ºè®®
          1. åœ¨æœ¬åœ°è¿è¡Œ `npm run preview` æµ‹è¯•æž„å»ºç»“æžœ
          2. æ£€æŸ¥æŽ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
          3. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ

          ## GitHub Pageséƒ¨ç½²
          åˆå¹¶åˆ°mainåˆ†æ”¯åŽå°†è‡ªåŠ¨éƒ¨ç½²åˆ°GitHub Pagesã€‚
          EOF

          echo "ðŸ“‹ éƒ¨ç½²æŠ¥å‘Šå·²ç”Ÿæˆ"
          cat deployment-report.md